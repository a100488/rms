+$(function() {

	// 严格模式
	"use strict";

	// =================================== 变量声明
	// =================================== //
	// ContextPath
	var sContextPath = rms.getContextPath();

	var oValidator;
	 var oSelect2Option = rms.getSelect2Option();
	
	// =================================== 方法声明
	// =================================== //
	// 画面初期事件绑定及JS插件渲染
	function initPageComponent() {
		// JS插件渲染渲染
		// 单项目验证
		oValidator = $("#editForm").validate(rms.getValidationOption());
		  // 数据表（datatables）渲染
        var oDataTableOption = rms.getDataTableOption(true);
        oDataTableOption.bFilter = true;
        oDataTableOption.ajax = {
            url: sContextPath + "/rest/role/role-list.json",
            data: function(oData) {
                // 过滤模态参数
                $.extend(oData, $("#filterForm").form2object());
            }
        };
        oDataTableOption.columns = [
            {data: "roleName"},
            {data: "memo"},
            {data: "deleteFlag"},
            {data: "uuid"}
        ];
        oDataTableOption.aoColumnDefs = [
            {
                fnCreatedCell: function(nTd, sData, oData, iRow, iCol) {
                    $(nTd).attr("title", sData);
                },
                aTargets: [0, 1]
            },
            {
                fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                	var sBtnHtml;
                	if (oData.deleteFlag == "0") {
                		sBtnHtml = '启用';
                	} else {
                		sBtnHtml = '禁用';
                	}
                    $(nTd).html(sBtnHtml);
                }, aTargets: [2]
            },
            {
                fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
                	var sBtnHtml;
                	if (oData.deleteFlag == "0") {
                		sBtnHtml = '<a href="javascript:;" class="btn btn-primary btn-xs" data-click="edit" data-click-data="' + iRow + '"><i class="fa fa-pencil"></i> 编辑</a> ';
                		
                		sBtnHtml += '<a href="javascript:;" class="btn btn-danger btn-xs" data-click="disable"  data-click-data="' + iRow + '"><i class="fa fa-ban"></i> 禁用</a>';
                		
                	} else {
                		sBtnHtml = '<a href="javascript:;" class="btn btn-primary btn-xs" data-click="edit" disabled="true"><i class="fa fa-pencil"></i> 编辑</a> ';
                		sBtnHtml += '<a href="javascript:;" class="btn btn-primary btn-xs" data-click="enable"  data-click-data="' + iRow + '"><i class="fa fa-adjust"></i> 启用</a>'
                	}
                    $(nTd).html(sBtnHtml);
                }, aTargets: [3]
            }
        ];
        oDataTableOption.oLanguage.sSearchPlaceholder="输入角色按回车键检索";
		var oDataTable = $("#roleTable").DataTable(oDataTableOption);

		// 添加过滤按钮
		$("#roleTable_wrapper div[class='col-md-6 col-sm-6'] input")
				.parent()
				.after(
						"<label><a id='filter' class='btn btn-white btn-sm m-r-xs'><i class='fa fa-filter'></i> 筛选</a></label>");

		// 事件绑定
		// 过滤模态【确定】按钮单事件绑定
		$("#filterConfirm").click(function() {
			oDataTable.ajax.reload();
		});

		// 【过滤】按钮单击事件绑定
		$("#filter").click(function() {
			$("#filterModal").modal();
		});
		var type="";
		// 【编辑】按钮单击事件绑定
		$("#roleTable").delegate(
				"a[data-click='edit']",
				"click",
			function() {
				$("#editModal").modal();
				
				var iRow = $(this).attr("data-click-data");
				var tableObj = $('#roleTable').dataTable();
				var rows = tableObj.fnGetData();
				var oData = rows[iRow];
				// 设置表单值
				  var uuid = oData['uuid'];
				  var memo=oData['memo'];
				  var roleName=oData['roleName'];
				  var permissionList=oData['rolePermissionList'];
				  $("#uuid").val(uuid);
				  $("#roleName").val(roleName);
				  $("#memo").val(memo);
				  var permissionIds= new Array();
				  if(permissionList!=null&&permissionList.length>0){
					  for(var i=0;i<permissionList.length;i++){
						  permissionIds[i] = permissionList[i].permissionUuid;
					  }
				  }
				  $("#permission").select2("val", permissionIds);
				  type="put";
		});
		
		// 【新增】按钮单击事件绑定
		$("#add").click(function() {
			$("#editModal").modal();
		
			// 重置表单
			$("#editForm").clearForm();
			  $("#permission").select2("val", ""); //清除选中值为初始值
			  type="post";
		});
		$("#editConfirm-edit").click(
				function() {
					updateRole();
				});
		
		function updateRole(){
			// 单项目验证
			if (!$("#editForm").valid()) {
				return false;
			}
			// 异步数据提交
			var oAjaxOption = {
				type : type,
				url : sContextPath + "/rest/role/role.json",
				contentType : "application/json",
				dataType : "json",
				data : $("form").form2json(),
				success : function(oData, oStatus) {
					rms.showSuccess("I001");
					oDataTable.ajax.reload();
					$("#editModal").modal('hide');
				},
				error : function(oData, oStatus, eErrorThrow) {
					rms.handleRemoteError(oData, oStatus, eErrorThrow);
				},
				complete : function(oXmlHttpRequest, oStatus) {
					$.unblockUI();
				}
			};
			$.blockUI(rms.getBlockOption());
			$.ajax(oAjaxOption);
		}
		// 【禁用】按钮事件绑定
		$("#roleTable")
				.delegate(
						"a[data-click='disable']",
						"click",
						function() {
							// 设定禁用所需要的uuid和拍他用的updateTime
							var oDelData = {};
							var iRow = $(this).attr("data-click-data");
							var tableObj = $('#roleTable').dataTable();
							var rows = tableObj.fnGetData();
							var oData = rows[iRow];
							// 设置表单值
							  var sUuid = oData['uuid'];
							oDelData.uuid = sUuid;
							oDelData.deleteFlag = "1";
							// 禁用弹出对话框事件绑定
							$(this).alert(
									function() {
										var bSuccess = false;
										var oAjaxOption = {
											type : "delete",
											url : sContextPath + "/rest/role/role.json",
											dataType : "json",
											contentType : 'application/json',
											data : JSON.stringify(oDelData),
											success : function(oData, oStatus) {
												rms.showSuccess("I001");
												bSuccess = true;
											},
											error : function(oData, oStatus,
													eErrorThrow) {
												rms.handleRemoteError(oData,
														oStatus, eErrorThrow);
											},
											complete : function(
													oXmlHttpRequest, oStatus) {
												$.unblockUI();
												// 禁用成功重新渲染表格
												if (bSuccess) {
													oDataTable.ajax.reload();
													
												}
											}
										};
										$.blockUI(rms.getBlockOption());
										$.ajax(oAjaxOption);
									});
						});

		// 【启用】按钮事件绑定
		$("#roleTable")
				.delegate(
						"a[data-click='enable']",
						"click",
						function() {
							// 设定启用所需要的uuid和拍他用的updateTime
							var oDelData = {};
							var iRow = $(this).attr("data-click-data");
							var tableObj = $('#roleTable').dataTable();
							var rows = tableObj.fnGetData();
							var oData = rows[iRow];
							// 设置表单值
							  var sUuid = oData['uuid'];
							oDelData.uuid = sUuid;
							oDelData.deleteFlag = "0";
							var bSuccess = false;
							var oAjaxOption = {
								type : "delete",
								url : sContextPath + "/rest/role/role.json",
								dataType : "json",
								contentType : 'application/json',
								data : JSON.stringify(oDelData),
								success : function(oData, oStatus) {
									rms.showSuccess("I001");
									bSuccess = true;
								},
								error : function(oData, oStatus, eErrorThrow) {
									rms.handleRemoteError(oData, oStatus,
											eErrorThrow);
								},
								complete : function(oXmlHttpRequest, oStatus) {
									$.unblockUI();
									// 启用成功重新渲染表格
									if (bSuccess) {
										oDataTable.ajax.reload();
									}
								}
							};
							$.blockUI(rms.getBlockOption());
							$.ajax(oAjaxOption);
						});
	}
	 // 画面初期数据获取
    function getPageData() {
        var oAjaxOption = {
                type: "get",
                url: sContextPath + "/rest/permission/permission-select_code.json",
                dataType: "json",
                success: function(oData, oStatus) {
                    // 画面初期数据设定
                	setSalesSelect(oData);
                },
                error: function(oData, oStatus, eErrorThrow) {
                    rms.handleRemoteError(oData, oStatus, eErrorThrow);
                },
                complete: function(oXmlHttpRequest, oStatus) {
                    $.unblockUI();
                }
        };
        $.blockUI(rms.getBlockOption());
        $.ajax(oAjaxOption);
    }
    function setSalesSelect(permissionList) {
		var options = "";
		if (permissionList) {
			$.each(permissionList, function(i, item) {
				
				options += "<option value='" + item.uuid + "'>" + item.permissionName
						+ "</option>";
			});
		}
		$("#permission").html(options);
		// 下拉列表框（select2）渲染
		oSelect2Option.templateSelection=formatState;
		$("#permission").select2(oSelect2Option);
		
	}
    	 
    
    	
    
	// 画面初期化
	function pageOnLoad() {
		 getPageData();
		// 画面初期事件绑定及JS插件渲染
		initPageComponent();
	}

	// =================================== 方法执行
	// =================================== //
	// 画面初期化
	pageOnLoad();
});
function formatState (data) {
	 return data ? defaultEscapeMarkup(data.text) : undefined;
	};
 function defaultEscapeMarkup(markup) {
	
        var replace_map = {
            '\\': '&#92;',
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            "/": '&#47;',
            "└":""	
        };
        return String(markup).replace(/[&<>"'\/\\└]/g, function (match) {
            return replace_map[match];
        }).trim();
    }
