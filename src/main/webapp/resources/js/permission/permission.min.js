+$(function() {
	// 严格模式
	"use strict";
	var sContextPath = rms.getContextPath();

	var aslocation = location.href.split("/");

	// 功能uuid
	var sPermissionUuid = aslocation[aslocation.length - 1];
	//编辑模态验证
    var oValidator;
    var thisData;
    var success=false;
    var lastBtn; 
	// 画面初期事件绑定及JS插件渲染
	function initPageComponent() {
		 // 验证器（validation）渲染
        oValidator = $("#editForm").validate(rms.getValidationOption());
		// 添加下属部门按钮按下事件
        
       
		$("#div-link").delegate("a[data-click='add']", "click", function() {
			if(success){
				
				 var parentUuid = $(this).attr("data-click-data");
					$("#editForm").clearForm();
					oValidator.resetForm();
					$("#editConfirm-edit").hide();
					$("#editConfirm-add").show();
					$("#parentUuid").val(parentUuid);
					//添加下级功能/菜单
					$("#header-modal").text(rms.locale["S019"]);
					$("#editModal").modal();
				 }else{
					 	lastBtn= $(this);
					 	$("#validForm").clearForm();
						$('#validModel').modal();
				 }
			
		});
		// 编辑按钮按下事件绑定
		$("#div-link").delegate(
				"a[data-click='edit']",
				"click",
				function() {
					if(success){
					var uuid = $(this).attr("data-click-data");
					var rowi = $(this).attr("data-click-data-row");
					$("#editForm").clearForm();
					oValidator.resetForm();
					$("#editConfirm-edit").show();
					$("#editConfirm-add").hide();
					//编辑
					$("#header-modal").text(rms.locale["S020"]);
					if(thisData!=null){
						for(var i=0;i<thisData.length;i++){
							if(thisData[i].uuid==uuid){
							$("#uuid").val(thisData[i].uuid);
						    $("#permissionName").val(thisData[i].permissionName);
						    $("#permission").val(thisData[i].permission);
							}
						}
					
					}
					$("#editModal").modal();
				}else{
					lastBtn= $(this);
					$("#validForm").clearForm();
					$('#validModel').modal();
				}
				});
		
		// 删除按钮按下事件
		$("#div-link")
				.delegate(
						"a[data-click='delete']",
						"click",
						function() {
						if(success){
							var sParentUuid = $(this).attr("data-click-data");
							var sDeptUuid = $(this).attr("data-click-data2");
							var lUpdateTime = $(this).attr("data-click-data3");
							$("#uuid").val(sDeptUuid);
							$(this).alert(
											function() {
												var oAjaxOption = {
													type : "delete",
													url : sContextPath
															+ "/rest/orginfo/org/"
															+ sDeptUuid
															+ ".json",
													contentType : "application/json",
													dataType : "json",
													data : '{"updateTime":'
															+ lUpdateTime + '}',
													success : function(oData,
															oStatus) {
														rms
																.getView(sContextPath
																		+ "/org/comp/wizard/step/3/"
																		+ sParentUuid);
													},
													error : function(oData,
															oStatus,
															eErrorThrow) {
														rms
																.handleRemoteError(
																		oData,
																		oStatus,
																		eErrorThrow);
													},
													complete : function(
															oXmlHttpRequest,
															oStatus) {
														$.unblockUI();
													}
												};
												$.blockUI(rms
														.getBlockOption());
												$.ajax(oAjaxOption);
											});
							 
							}else{
								lastBtn= $(this);
								$("#validForm").clearForm();
								$('#validModel').modal();
								}
						});
		// 编辑模态确定按钮事件绑定
		$("#editConfirm-edit").click(
				function() {
					
					if (!$("#editForm").valid()) {
						return false;
					}
					var oAjaxOption = {
						type : "put",
						url : sContextPath + "/rest/permission/permission.json",
						contentType : "application/json",
						data : $("#editForm").form2json(),
						dataType : "json",
						success : function(oData, oStatus) {
							location.reload();
						},
						error : function(oData, oStatus, eErrorThrow) {
							rms.handleRemoteError(oData, oStatus,
									eErrorThrow);
						},
						complete : function(oXmlHttpRequest, oStatus) {
							$.unblockUI();
						}
					};
					$.blockUI(rms.getBlockOption());
					$.ajax(oAjaxOption);
				});
		// 新增模态确定按钮事件绑定
		$("#editConfirm-add").click(
				function() {
					var uuid = $("#uuid").val();
					if (!$("#editForm").valid()) {
						return false;
					}
					var bSuccess = false;
					var oAjaxOption = {
						type : "post",
						url : sContextPath + "/rest/permission/permission.json",
						data : $("#editForm").form2json(),
						dataType : "json",
						contentType: "application/json",
						success : function(oData, oStatus) {
							rms.showSuccess("I001");
							bSuccess = true;
						},
						error : function(oData, oStatus, eErrorThrow) {
							rms.handleRemoteError(oData, oStatus,
									eErrorThrow);
						},
						complete : function(oXmlHttpRequest, oStatus) {
							$.unblockUI();
							if (bSuccess) {
								location.reload();
							}
						}
					};
					$.blockUI(rms.getBlockOption());
					$.ajax(oAjaxOption);
				});

	}
	$("#validConfirm").click(function(){
			
			if (!$("#validForm").valid()) {
				return false;
			}
			var validCode=$("#validCode").val();
			var bSuccess = false;
			var oAjaxOption = {
				type : "post",
				url : sContextPath + "/rest/permission/permissionValid/"+validCode+".json",
				
				dataType : "json",
				contentType: "application/json",
				success : function(oData, oStatus) {
					rms.showSuccess("I004");
					bSuccess = true;
					
				},
				error : function(oData, oStatus, eErrorThrow) {
					success=false;
					rms.handleRemoteError(oData, oStatus,
							eErrorThrow);
				},
				complete : function(oXmlHttpRequest, oStatus) {
					$.unblockUI();
					if (bSuccess) {
						$("#validModel").modal('hide');
						success=true;
						lastBtn.click();
					}
				}
			};
			$.blockUI(rms.getBlockOption());
			$.ajax(oAjaxOption);
		});
	
	
	// 获取所有的功能信息
	function getLinkData() {

		var oAjaxOption = {
			type : "get",
			url : sContextPath + "/rest/permission/permission.json",
			contentType : "application/json",
			dataType : "json",
			success : function(oData, oStatus) {
				setLinkData(oData, oStatus);
				
			},
			error : function(oData, oStatus, eErrorThrow) {
				rms.handleRemoteError(oData, oStatus, eErrorThrow);
			},
			complete : function(oXmlHttpRequest, oStatus) {
				$.unblockUI();
			}
		};
		$.blockUI(rms.getBlockOption());
		$.ajax(oAjaxOption);
	}

	// 设置树形链接
	function setLinkData(oData, oStatus) {
		thisData=oData.data;
		$("#div-link")
				.append(
						'<div class="permission"><div class="box">'
								+ '<a class="a-link" href="'
								+ sContextPath
								+ '/permission/query"  title="'
								+ oData.permissionName
								+ '">'
								+ oData.permissionName
								+ '</a>'
								+ '<div class="div-btn-first">'
								+ '<a href="javascript:;" class="btn btn-primary" data-click="add" data-click-data="0"><i class="fa fa-plus"></i> </a> '
								+ '</div></div></div>');

		$
				.each(
						oData.data,
						function(n, value) {
							var sParentUuid;
							if (value.parentUuid == null) {
								sParentUuid = "0";
							} else {
								sParentUuid = value.parentUuid;
							}
							var sHtml = '<div class="permission">';
							var i = 1;
							var iLengthIndex = value.orgaRelaIndex.length / 21;
							for (i = 1; i <= iLengthIndex; i++) {
								sHtml = sHtml
										+ '<span class="span-tab"></span>';
							}
							sHtml = sHtml + '<div class="box">';

							if (sPermissionUuid != value.uuid) {
								sHtml = sHtml
										+ '<a class="a-link" title="'
										+ value.permissionName
										+ '" href="'
										+ sContextPath
										+ '/rest/permission/qyeryQermission.json'
										+ value.uuid + '">';

							} else {
								sHtml = sHtml
										+ '<a class="current a-link" title="'
										+ value.permissionName
										+ '"  href="javascript:;">';
							}
							sHtml = sHtml + '&#9492&nbsp;'
									+ value.permissionName
									+ '</a><div class="div-btn">';
							sHtml = sHtml
									+ '<a href="javascript:;" class="btn btn-primary" data-click="edit" data-click-data="'
									+ value.uuid
									+ '" data-click-data-row="'+n+'"><i class="fa fa-pencil"></i> </a> '
									+ ' <a href="javascript:;" class="btn btn-danger" data-click="delete" data-click-data="'
									+ sParentUuid
									+ '" data-click-data2="'
									+ value.uuid
									+ 'data-click-data-row="'+n+'"><i class="fa fa-trash"></i> </a> '
									+ ' <a href="javascript:;" class="btn btn-primary" data-click="add" data-click-data="'
									+ value.uuid
									+ '"><i class="fa fa-plus"></i> </a> ';
							sHtml = sHtml + '</div></div>';
							$("#div-link").append(sHtml);

						});
	}
	
	// 画面初期化
	function pageOnLoad() {

		getLinkData();// 获取所有功能信息
		// 画面初期事件绑定及JS插件渲染
		initPageComponent();

	}
	// =================================== 方法执行
	// =================================== //
	// 画面初期化
	pageOnLoad();
});